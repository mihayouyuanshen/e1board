/****************************************************************************/
/*	Description		:32bit CRC計算											*/
/*--------------------------------------------------------------------------*/
/*	Author			:DHC Gu.CM												*/
/*--------------------------------------------------------------------------*/
/*	Date			:2023/03/22												*/
/*--------------------------------------------------------------------------*/
/*	Module Name		:														*/
/*--------------------------------------------------------------------------*/
/*	Note			:														*/
/*--------------------------------------------------------------------------*/
/*	Copyright		:(c) 2020 NICHICON CORPORATION							*/
/****************************************************************************/

/*--------------------------------------------------------------------------*/
/*	Include Header File														*/
/*--------------------------------------------------------------------------*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "common_g.h"
#include "dlog_g.h"
#include "cmn_crc32.h"

/*--------------------------------------------------------------------------*/
/*	公開変数定義															*/
/*--------------------------------------------------------------------------*/


/*--------------------------------------------------------------------------*/
/*	非公開変数定義															*/
/*--------------------------------------------------------------------------*/
#define CMN_CRC_TABLE_SIZE		((ushort)256u)
#define CMN_CRC_FIDUCCIAL_VAL	((ulong)0xEDB88320u)
#define CMN_BYTE_BIT			((uchar)8u)

/* CRC計算用テーブル */
ulong s_cmnCrc32Table[CMN_CRC_TABLE_SIZE];
bool_t s_cmnCrc32TableMk = FALSE;

/*--------------------------------------------------------------------------*/
/*	公開関数定義															*/
/*--------------------------------------------------------------------------*/
/*==========================================================================*/
/*	Description		:32bit CRC計算											*/
/*--------------------------------------------------------------------------*/
/*	param			:uchar *buf	計算対象データ								*/
/*					:ulong len	対象データバイト数							*/
/*--------------------------------------------------------------------------*/
/*	return			:ulong 32bit	CRC計算値								*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/03/22 : DHC Gu.CM : 新規作成						*/
/*==========================================================================*/
ulong CMN_Crc32(uchar *buf, ulong len)
{
	ulong c = 0xFFFFFFFF;
	ulong i;

	DEBUG_TRCIN();

	if (NULL == buf)
	{
		return c;
	}

	if (TRUE != s_cmnCrc32TableMk)
	{
		cmn_Crc32MakeTable();
		s_cmnCrc32TableMk = TRUE;
	}

	for(i = 0; i < len; i++) 
	{
		c = s_cmnCrc32Table[(c ^ buf[i]) & 0xFF] ^ (c >> 8);
	}

	c = c ^ 0xFFFFFFFF;

	DEBUG_TRCOUT();

	return c;
}

/*==========================================================================*/
/*	Description		:32bit CRC計算											*/
/*--------------------------------------------------------------------------*/
/*	param			:uchar *buf	計算対象データ								*/
/*					:ulong len	対象データバイト数							*/
/*					:ulong c												*/
/*--------------------------------------------------------------------------*/
/*	return			:ulong 32bit CRC計算値									*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/09 : DHC Gu.CM : 新規作成						*/
/*==========================================================================*/
ulong CMN_Crc32Type2(uchar *buf, ulong len, ulong c)
{
	ulong i;

	DEBUG_TRCIN();

	if (NULL == buf)
	{
		return c;
	}

	if (TRUE != s_cmnCrc32TableMk)
	{
		cmn_Crc32MakeTable();
		s_cmnCrc32TableMk = TRUE;
	}

	for(i = 0; i < len; i++)
	{
		c = s_cmnCrc32Table[(c ^ buf[i]) & 0xFF] ^ (c >> 8);
	}

	c = c ^ 0xFFFFFFFF;

	DEBUG_TRCOUT();

	return c;
}
/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/25 : DHC Cao.HZ : 新規作成						*/
/*==========================================================================*/
ulong CMN_Crc32L2Buf(ulong crc, uchar *buf)
{
	uchar crc_buff[4] = {0};

	if(buf == NULL)
	{
		return -1;
	}
	crc_buff[0] = (uchar)((crc >> 24) & 0xFF);
	crc_buff[1] = (uchar)((crc >> 16) & 0xFF);
	crc_buff[2] = (uchar)((crc >> 8) & 0xFF);
	crc_buff[3] = (uchar)((crc) & 0xFF);

	memcpy(buf, crc_buff, 4);
	return 0;
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/25 : DHC Cao.HZ : 新規作成						*/
/*==========================================================================*/
ulong CMN_Crc32Buf2L(uchar *buf)
{
	ulong crc = 0;
	uchar crc_buff[4] = {0};
	if(buf == NULL)
	{
		return -1;
	}
	memcpy(crc_buff, buf, 4);
	crc = (((ulong)crc_buff[0] << 24) & 0xFF000000) |
			(((ulong)crc_buff[1] << 16) & 0x00FF0000) |
			(((ulong)crc_buff[2] << 8) & 0x0000FF00) |
			((ulong)crc_buff[3] & 0x000000FF);
	return crc;
}

/*--------------------------------------------------------------------------*/
/*	非公開関数定義															*/
/*--------------------------------------------------------------------------*/
/*==========================================================================*/
/*	Description		:CRC計算用テーブル初期化								*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/09 : DHC Gu.CM : 新規作成						*/
/*==========================================================================*/
void cmn_Crc32MakeTable(void)
{
	ulong i;
	ulong j;
	ulong c;

	DEBUG_TRCIN();

	for(i = 0; i < CMN_CRC_TABLE_SIZE; i++)
	{
		c = i;
		for(j = 0; j < CMN_BYTE_BIT; j++)
		{
			c = (c & 1) ? (CMN_CRC_FIDUCCIAL_VAL ^ (c >> 1)) : (c >> 1);
		}
		s_cmnCrc32Table[i] = c;
	}

	DEBUG_TRCOUT();
}


/* End Of File */
