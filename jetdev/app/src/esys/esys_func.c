/****************************************************************************/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	Author			:DHC Chen.H												*/
/*--------------------------------------------------------------------------*/
/*	Date			:2023/04/19												*/
/*--------------------------------------------------------------------------*/
/*	Module Name		:														*/
/*--------------------------------------------------------------------------*/
/*	Note			:														*/
/*--------------------------------------------------------------------------*/
/*	Copyright		:(c) 2020 NICHICON CORPORATION							*/
/****************************************************************************/

/*--------------------------------------------------------------------------*/
/*	Include Header File														*/
/*--------------------------------------------------------------------------*/
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <fcntl.h>
#include "task_g.h"
#include "esys_cmn_g.h"
#include "esys_func.h"
#include "eled_g.h"
#include "dlog_g.h"
#include "lfw_g.h"
#include "wdt_g.h"
#include "enet_g.h"

/*--------------------------------------------------------------------------*/
/*	公開変数定義															*/
/*--------------------------------------------------------------------------*/


/*--------------------------------------------------------------------------*/
/*	非公開変数定義															*/
/*--------------------------------------------------------------------------*/
bool_t s_esysLedRelatedErrDetected = FALSE;
bool_t s_esysReadEEPromErrFlg = FALSE;
/*--------------------------------------------------------------------------*/
/*	公開関数定義															*/
/*--------------------------------------------------------------------------*/
/*==========================================================================*/
/*	Description		:系统唤醒												*/
/*--------------------------------------------------------------------------*/
/*	param			:void													*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:系统唤醒，防止系统自动重启									*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/19 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
void esys_SystemWakeup(void)
{
	DEBUG_TRCIN();
	system(ESYS_STSTEM_WAKEUP_CMD);
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:开始固件更新											*/
/*--------------------------------------------------------------------------*/
/*	param			:void													*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:开始固件更新											*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/19 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
void esys_StartFwUpdate(void)
{
	DEBUG_TRCIN();
	/* TODO */
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:紧急停止												*/
/*--------------------------------------------------------------------------*/
/*	param			:void													*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:紧急停止												*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/19 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
void esys_EmergencyStop(void)
{
	DEBUG_TRCIN();
	/* TODO */
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:关机													*/
/*--------------------------------------------------------------------------*/
/*	param			:void													*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:关机													*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/19 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
void esys_ShutDown(void)
{
	DEBUG_TRCIN();
	WDT_AsyncSendShutdownReq();
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:リブート要求											*/
/*--------------------------------------------------------------------------*/
/*	param			:void													*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:リブート要求											*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/19 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_Reboot(void)
{
	DEBUG_TRCIN();
	WDT_AsyncSendRebootReq();
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:プロセスWDT応答										*/
/*--------------------------------------------------------------------------*/
/*	param			:void													*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:プロセスWDT応答										*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/19 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_SendWdtRes(void)
{
	DEBUG_TRCIN();
	WDT_AsyncSendWdtRes(WDT_PROC_TIMEOUT_DEF);
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:プロセス終了応答										*/
/*--------------------------------------------------------------------------*/
/*	param			:void													*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:プロセス終了応答										*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/19 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_SendTermRes(WdtTermType_t type)
{
	DEBUG_TRCIN();
	WDT_AsyncSendTermRes(type);
	DEBUG_TRCOUT();
}
/*==========================================================================*/
/*	Description		:按键事件处理											*/
/*--------------------------------------------------------------------------*/
/*	param			:ushort msgId：消息ID									*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:按键事件处理											*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/19 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
void esys_KeyEventProc(ushort msgId)
{
	DEBUG_TRCIN();
	switch (msgId)
	{
		case ESYS_MSGID_KEY1_PRESSED:
			DLOG_Info("BUTTON1 SHORT PRESS");
			esys_StartFwUpdate();
			break;
		case ESYS_MSGID_KEY1_LONG_PRESSED:
			DLOG_Info("BUTTON1 LONG PRESS");
			esys_EmergencyStop();
			break;
		case ESYS_MSGID_KEY2_PRESSED:
			DLOG_Info("BUTTON2 SHORT PRESS");
			break;
		case ESYS_MSGID_KEY2_LONG_PRESSED:
			DLOG_Info("BUTTON2 LONG PRESS");
			esys_ShutDown();
			break;
		case ESYS_MSGID_SW1_ON:
			DLOG_Info("SW1 ON");
			break;
		case ESYS_MSGID_SW1_OFF:
			DLOG_Info("SW1 OFF");
			break;
		case ESYS_MSGID_SW2_ON:
			DLOG_Info("SW2 ON");
			break;
		case ESYS_MSGID_SW2_OFF:
			DLOG_Info("SW2 OFF");
			break;
		case ESYS_MSGID_SW3_ON:
			DLOG_Info("SW3 ON");
			break;
		case ESYS_MSGID_SW3_OFF:
			DLOG_Info("SW3 OFF");
			break;
		case ESYS_MSGID_SW4_ON:
			DLOG_Info("SW4 ON");
			break;
		case ESYS_MSGID_SW4_OFF:
			DLOG_Info("SW4 OFF");
			break;
		default:
			DLOG_Error("Unknown msg id = %u\n", msgId);
			break;
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:デバッグログ出力管理									*/
/*--------------------------------------------------------------------------*/
/*	param			:void													*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:デバッグログ出力管理									*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/04/19 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_DebugLogProc(void)
{
	sint ret, fd, rdSz;
	struct stat swFileSt;
	schar swVal;
	uchar logOnFlag = 0;

	/* ファイル存在チェック */
	ret = stat(ESYS_DEBUG_LOG_SWITCH_FILE, &swFileSt);
	if ((0 == ret) && ((slong)1 == swFileSt.st_size))
	{
		/* ファイル読み出し */
		fd = open(ESYS_DEBUG_LOG_SWITCH_FILE, O_RDONLY);
		if (0 <= fd)
		{
			rdSz = read(fd, (uchar*)&swVal, sizeof(swVal));
			if ((rdSz == sizeof(swVal)) && (ESYS_DEBUG_LOG_ON == swVal))
			{
				logOnFlag = 1;
			}
			else
			{
				/* 処理無し */
			}
			close(fd);
		}
	}
	else
	{
		/* 処理無し */
	}

	if (logOnFlag)
	{
		DLOG_Init(ESYS_DEBUG_LOG_DIR, 
				ESYS_DEBUG_LOG_PREFIX,
				ESYS_DEBUG_LOG_MAX_SZ, 
				ESYS_DEBUG_LOG_MAX_NUM, 
				DLOG_OUT_MODE_FILE,
				ESYS_DEBUG_LOG_CRT_INTERVAL_S);
	}
	else
	{
		/* 処理無し */
	}
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_PowerCutStChgProc(PowerCutOperation_t status)
{
	DEBUG_TRCIN();
	if (OPERATION_PWRON == status)
	{
		ENET_AsyncRestartWiFi();
		ELED_PwrLedBlankStop(ELED_PWRLED_TESTRUN);
	}
	else
	{
		ELED_PwrLedBlankStart(ELED_PWRLED_TESTRUN);
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_ProcErrForWifi(const EdatErrInfo_t *errInfo)
{
	DEBUG_TRCIN();
	if (0 == strcmp("BC096", errInfo->errCode))
	{
		ENET_AsyncSetDeviceRun(ENET_TEST_MODE);
	}
	else
	{
		/* 処理無し */
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_ProcErrForLed(const EdatErrInfo_t *errInfo)
{
	DEBUG_TRCIN();
	/* CMD65:運転／停止=0:停止に ACK 応答 */
	if (0 == strcmp("BC096", errInfo->errCode))
	{
		ELED_PwrLedBlankStart(ELED_PWRLED_SHUTDOWN);
	}
	else
	{
		esys_LedRelatedErrDetected();
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_ClearErrForWifi(const EdatErrInfo_t *errInfo)
{
	DEBUG_TRCIN();
	if (0 == strcmp("BC096", errInfo->errCode))
	{
		ENET_AsyncSetDeviceRun(ENET_NORMAL_MODE);
	}
	else
	{
		/* 処理無し */
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_ClearErrForLed(const EdatErrInfo_t *errInfo)
{
	DEBUG_TRCIN();
	if (0 == strcmp("BC096", errInfo->errCode))
	{
		ELED_PwrLedBlankStop(ELED_PWRLED_SHUTDOWN);
	}
	else
	{
		esys_LedRelatedErrDetected();
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_ErrorHappenProc(const EdatErrInfo_t *errInfo)
{
	DEBUG_TRCIN();
	esys_ProcErrForWifi(errInfo);
	esys_ProcErrForLed(errInfo);
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_ErrorCancelProc(const EdatErrInfo_t *errInfo)
{
	DEBUG_TRCIN();
	esys_ClearErrForWifi(errInfo);
	esys_ClearErrForLed(errInfo);
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_ModStartRsltProc(ulong modId, ModActionResult_t result)
{
	DEBUG_TRCIN();
	if (MOD_ACTION_RESULT_SUCCESS == result)
	{
		switch (modId)
		{
			case EINV_SPORT:
				DLOG_Info("<<<<<<System Running>>>>>>");
				printf("\n<<<<<<System Running>>>>>>\n");
				break;
			default :
				break;
		}
	}
	else if (MOD_ACTION_RESULT_FAILED == result)
	{
		switch (modId)
		{
			case EINV_SPORT:
				DLOG_Info("<<<<<<System Running>>>>>>");
				printf("\n<<<<<<System Running>>>>>>\n");
				break;
			default :
				break;
		}
	}
	else
	{
		/* 処理無し */
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_ModStopRsltProc(ulong modId, ModActionResult_t result)
{
	DEBUG_TRCIN();
	/* TODO */
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_LedRelatedErrDetected(void)
{
	bool_t isErrDetected = FALSE;
	DEBUG_TRCIN();
	if ((EDAT_OK == EDAT_FindErrByPrefix(EERR_TYPE_PCS, "BF"))
		|| (EDAT_OK == EDAT_FindErrByPrefix(EERR_TYPE_PCS, "BE"))
		|| (EDAT_OK == EDAT_FindErrByPrefix(EERR_TYPE_BOARD, "BF"))
		|| (EDAT_OK == EDAT_FindErrByPrefix(EERR_TYPE_BOARD, "BE"))
		|| (EDAT_OK == EDAT_FindErrByPrefix(EERR_TYPE_RMC, "BF"))
		|| (EDAT_OK == EDAT_FindErrByPrefix(EERR_TYPE_RMC, "BE"))
		|| (TRUE == s_esysReadEEPromErrFlg))
	{
		isErrDetected = TRUE;
	}
	else
	{
		isErrDetected = FALSE;
	}

	if (isErrDetected != s_esysLedRelatedErrDetected)
	{
		if (isErrDetected)
		{
			ELED_PwrLedBlankStart(ELED_PWRLED_ERROR);
		}
		else
		{
			ELED_PwrLedBlankStop(ELED_PWRLED_ERROR);
		}
		s_esysLedRelatedErrDetected = isErrDetected;
	}
	else
	{
		/* 処理無し */
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_SetReadEEPromErr(void)
{
	DEBUG_TRCIN();
	s_esysReadEEPromErrFlg = TRUE;
	esys_LedRelatedErrDetected();
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:														*/
/*--------------------------------------------------------------------------*/
/*	param			:														*/
/*--------------------------------------------------------------------------*/
/*	return			:														*/
/*--------------------------------------------------------------------------*/
/*	detail			:														*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/05/06 : DHC Chen.H : 新規作成						*/
/*==========================================================================*/
void esys_ClearReadEEPromErr(void)
{
	DEBUG_TRCIN();
	s_esysReadEEPromErrFlg = FALSE;
	esys_LedRelatedErrDetected();
	DEBUG_TRCOUT();
}

/*--------------------------------------------------------------------------*/
/*	非公開関数定義															*/
/*--------------------------------------------------------------------------*/


/*End Of File*/
