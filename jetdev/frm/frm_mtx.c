/****************************************************************************/
/*	Description		:互斥量													*/
/*--------------------------------------------------------------------------*/
/*	Author			:DHC Chen.H												*/
/*--------------------------------------------------------------------------*/
/*	Date			:2023/03/16												*/
/*--------------------------------------------------------------------------*/
/*	Module Name		:frm_mtx												*/
/*--------------------------------------------------------------------------*/
/*	Note			:进程间有效互斥量										*/
/*--------------------------------------------------------------------------*/
/*	Copyright		:(c) 2020 NICHICON CORPORATION							*/
/****************************************************************************/

/*--------------------------------------------------------------------------*/
/*	Include Header File														*/
/*--------------------------------------------------------------------------*/
#include <sys/sem.h>
#include "dlog_g.h"
#include "frm_mtx.h"
#include "frm_mtx_g.h"

/*--------------------------------------------------------------------------*/
/*	公開変数定義															*/
/*--------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------*/
/*	非公開変数定義															*/
/*--------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------*/
/*	公開関数定義															*/
/*--------------------------------------------------------------------------*/

/*==========================================================================*/
/*	Description		:创建互斥量												*/
/*--------------------------------------------------------------------------*/
/*	param			:slong key:互斥量key									*/
/*--------------------------------------------------------------------------*/
/*	return			:ProcessMutex_t：互斥量ID								*/
/*--------------------------------------------------------------------------*/
/*	detail			:创建线程间有效的互斥量									*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/03/16 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
ProcessMutex_t FRM_MutexCreate(slong key)
{
	ProcessMutex_t mutexId = 0;
	DEBUG_TRCIN();

	/* 使用Key创建信号量，初始值为1 */
	mutexId = frm_SemCreate(key, 1);
	DEBUG_TRCOUT();
	return mutexId;
}

/*==========================================================================*/
/*	Description		:锁定互斥量												*/
/*--------------------------------------------------------------------------*/
/*	param			:ProcessMutex_t mutexId:互斥量ID						*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:锁定互斥量												*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/03/16 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
void FRM_MutexLock(ProcessMutex_t mutexId)
{
	DEBUG_TRCIN();
	/* 信号量减一 */
	frm_SemP(mutexId);
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:解锁互斥量												*/
/*--------------------------------------------------------------------------*/
/*	param			:ProcessMutex_t mutexId:互斥量ID						*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:解锁互斥量												*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/03/16 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
void FRM_MutexUnLock(ProcessMutex_t mutexId)
{
	DEBUG_TRCIN();
	/* 信号量加一 */
	frm_SemV(mutexId);
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:删除互斥量												*/
/*--------------------------------------------------------------------------*/
/*	param			:ProcessMutex_t mutexId:互斥量ID						*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:删除互斥量												*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/03/16 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
void FRM_MutexRemove(ProcessMutex_t mutexId)
{
	DEBUG_TRCIN();
	/* 删除信号量 */
	frm_SemRemove(mutexId);
	DEBUG_TRCOUT();
}

/*--------------------------------------------------------------------------*/
/*	非公開関数定義															*/
/*--------------------------------------------------------------------------*/
/*==========================================================================*/
/*	Description		:创建信号量												*/
/*--------------------------------------------------------------------------*/
/*	param			:slong key:信号量key									*/
/*--------------------------------------------------------------------------*/
/*	param			:sint initVal:信号量初始值								*/
/*--------------------------------------------------------------------------*/
/*	return			:sint													*/
/*--------------------------------------------------------------------------*/
/*	detail			:创建信号量												*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/03/16 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
static sint frm_SemCreate(slong key, sint initVal)
{
	sint semId = 0;
	SemUnion_t semInfo;
	DEBUG_TRCIN();

	/* 使用Key创建信号量 */
	semId = semget((key_t)key, 1, 0666 | IPC_CREAT | IPC_EXCL);
	if (-1 == semId)
	{
		DLOG_Info("sem already exist");
		semId = semget((key_t)key, 1, 0666 | IPC_CREAT);
	}
	else
	{
		/* 设定信号量初始值 */
		semInfo.val = initVal;
		if (-1 == (semctl(semId, 0, SETVAL, semInfo)))
		{
			DLOG_Error("semctl SETVAL error");
		}
		else
		{
			/* 処理無し */
		}
	}
	DEBUG_TRCOUT();
	return semId;
}

/*==========================================================================*/
/*	Description		:减少信号量计数											*/
/*--------------------------------------------------------------------------*/
/*	param			:sint semId:信号量Id									*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:减少信号量计数											*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/03/16 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
static void frm_SemP(sint semId)
{
	struct sembuf semBuf;
	DEBUG_TRCIN();

	/* 信号量减一 */
	semBuf.sem_num = 0;
	semBuf.sem_op = -1;
	semBuf.sem_flg = SEM_UNDO;
	if (-1 == (semop(semId, &semBuf, 1)))
	{
		DLOG_Error("semop error");
	}
	else
	{
		/* 処理無し */
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:增加信号量计数											*/
/*--------------------------------------------------------------------------*/
/*	param			:sint semId:信号量Id									*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:增加信号量计数											*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/03/16 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
static void frm_SemV(sint semId)
{
	struct sembuf semBuf;
	DEBUG_TRCIN();

	/* 信号量加一 */
	semBuf.sem_num = 0;
	semBuf.sem_op = 1;
	semBuf.sem_flg = SEM_UNDO;
	if (-1 == (semop(semId, &semBuf, 1)))
	{
		DLOG_Error("semop error");
	}
	else
	{
		/* 処理無し */
	}
	DEBUG_TRCOUT();
}

/*==========================================================================*/
/*	Description		:删除信号量												*/
/*--------------------------------------------------------------------------*/
/*	param			:sint semId:信号量Id									*/
/*--------------------------------------------------------------------------*/
/*	return			:void													*/
/*--------------------------------------------------------------------------*/
/*	detail			:删除信号量												*/
/*--------------------------------------------------------------------------*/
/*	history			:2023/03/16 : DHC Chen.H : 新規作成					*/
/*==========================================================================*/
static void frm_SemRemove(sint semId)
{
	SemUnion_t semInfo;
	DEBUG_TRCIN();

	/* 删除信号量 */
	if (-1 == (semctl(semId, 0, IPC_RMID, semInfo)))
	{
		DLOG_Error("semctl IPC_RMID error");
	}
	else
	{
		/* 処理無し */
	}
	DEBUG_TRCOUT();
}

/*End Of File*/
